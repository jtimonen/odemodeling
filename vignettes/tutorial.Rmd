---
title: "Defining and fitting ODE models using the odemodeling package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Defining and fitting ODE models using the odemodeling package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(odemodeling)
```

# Creating a model

We define an ODE system describing a simple harmonic oscillator, 
with only one parameter `theta`. We need to
define the variable for the initial system state at `t0` as `y0`. The ODE
system dimension is declared as `D` and number of time points as `N`.

```{r sho_define}
N <- stan_dim("N", lower=1)
D <- stan_dim("D")
y0 <- stan_vector("y0", length = D)
theta <- stan_param(stan_var("theta", lower=0), "inv_gamma(5, 1)")
sho_fun_body <- "
  vector[2] dy_dt;
  dy_dt[1] = y[2];
  dy_dt[2] = - y[1] - theta*y[2];
  return(dy_dt);
"
```

The following code creates and compiles the Stan model.
```{r sho_create}
sho <- ode_model(N,
                 odefun_vars = list(theta), 
                 odefun_body = sho_fun_body,
                 odefun_init = y0)
print(sho)
#print(sho$stanmodel) # this would print the full Stan code
```

# Sampling from prior

We can sample from the prior distribution of model parameters like so.

```{r sho_prior_sample}
sho_fit_prior <- sho$sample( 
  t0 = 0.0, 
  t = seq(0.1, 10, by = 0.1),
  data = list(y0 = c(1, 0), D = 2),
  refresh = 0,
  solver = rk45(
    abs_tol = 1e-13,
    rel_tol = 1e-13,
    max_num_steps = 1e9
  )
)
```

We can view a summary of results 
```{r sho_fit_print}
print(sho_fit_prior)
```

We can obtain the ODE solution using each parameter draw by doing
```{r sho_fit_view_ode1}
ys <- sho_fit_prior$extract_odesol_df()
```

We can plot ODE solutions like so
```{r sho_fit_view_ode2, fig.width=6.5, fig.height=3.2}
sho_fit_prior$plot_odesol(linealpha = 0.3)
```

We can plot ODE solution using one draw like so
```{r sho_fit_view_ode3, fig.width=6.5, fig.height=3.2}
sho_fit_prior$plot_odesol(draw_inds = 45)
```

# Using different solvers
We generate quantities using a different solver and different time points.
```{r sho_gq, fig.width=6.5, fig.height=3.2}
gq <- sho_fit_prior$simulate(solver=bdf(), t = seq(0.5,10,by=0.5))
```

We can again plot ODE solution using one draw like so
```{r sho_view_gq, fig.width=6.5, fig.height=3.2}
gq$plot_odesol(draw_inds = 45)
```
